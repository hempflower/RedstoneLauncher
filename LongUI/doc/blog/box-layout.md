# Size 种类

以width作为例子

类型|         下限 |      建议    | 上限
----|--------------|--------------|----------
CSS | min-width    |         width| max-width
LUI | limited-width| fitting-width| max-width


CSS的属性会覆写LUI属性对应值，并且处于高优先级。即：
 - 如果指定了CSS属性，那么写入对应的LUI属性，再标记处于CSS状态
 - 如果没有指定CSS属性，那么LUI属性会按照相应的规则处理
 - 可以通过`style`或者直接的属性进行CSS属性设置
 - (例: 可以使用xml属性`minwidth`或者css属性`min-width`设置)

```cpp
case BKDR_MINWIDTH:
    // minwidth    : width属性下限
    m_oStyle.limited.width = value.ToFloat();
    /* xxx */
    break;
```


一个最简单的例子就是图像`<image>`，建议宽度就是使用图片的宽度，下限宽度可以考虑`0`。但是需要设置`flex`为有效值, 否则布局器依然会按照图片尺寸布局.

复杂点的例子就是箱型布局`<box>`。LongUI中，使用对应滚动条(这里就是水平滚动条)的`<box>`下限宽度会调整到`0`，建议宽度依然是有效子控件建议宽度(以及 `margin` 什么的，具体来说是 CSS 属性`box-sizing`控制的，XUL默认是`box-sizing: border-box`, LongUI中目前不支持动态切换`box-sizing`)累加.

而一旦使用CSS值，则以设置值为准。

正常控件大小应该介于建议值与最大值之间，特殊情况会处于最小值与建议值之间。而这种特殊情况`<box>`处理方式有点违背常理——`flex`越大的值反而最小，可以理解为**以建议值作为起点**，`flex`作为伸缩参数，越大的伸得越大，缩得也越小。


# 布局算法

仔细观察了firefox的行为, 个人猜测firefox的布局算法是增量式的算法. 而LongUI目前是全量算法，主要原因有
 - 浮点误差: 由于LongUI使用浮点作为基础值. 增量算法误差会随着浮点变化而累计, 从而触发UB——连自己都不知道会出现什么BUG, 可能会和寒鸦号一样
 - 上下文数据储存: 增量当然要额外储存上下文数据，但是这个数据自己看来并不是必须的(全量算法的话)

由于算法不同, 全量的布局器的行为与增量不同, 这里只要是指针对`splitter`的实现, 很难像增量那样处理.

LongUI中`<box>`布局算法如下, 为了方便说明先定义一些东西:
 - 有效布局子控件: `<box>`子控件中不是所有子控件都参与布局，最简单的，如果`visible`为`false` 或者是类似于滚动条之类的控件，是不参与布局的。而参与布局的子控件这里称为 有效布局子控件
 - 最低滚动尺寸: 如果内容区大小小于这个尺寸就需要显示滚动条或者滚动按钮
 - 建议尺寸: 这个上面以及说明了
 - 有效内容区大小: 所有的控件应该将子控件放在内容区，而`box`可能有滚动条或者滚动按钮，如果显示这些控件，有效内容区需要减去这些。
 
具体算法，以`<hbox>`为栗子:
 1. 确定有效内容区大小，自身建议宽度等预备数据
 2. 先将有效布局子控件中`flex`(作为`f`)累加起来作为`F`，`F`自然最小为`0`
 3. 有效内容区宽度 减去 建议宽度 作为`S`, 注意`S`可能为负数
 4. 遍历每个有效布局子控件，将控件临时宽度设置为建议宽度
 5. 令`U = S / F`. 当`F`为`0`时, 结束计算. 之后再清空`F`. (注: 如果`F`实现为浮点数时候注意浮点误差)
 6. 遍历每个有效布局子控件
 7. 将控件临时宽度 加上 `f * U`, 注意需要将宽度钳制到上下限值之间
 8. 让`S`减去 实际变化量
 9. `S`有变化，并且当宽度被钳制时, 让`F`累加`f`
 10. 当`S`足够接近0时退出. 否则回到步骤5


算法复杂度: 
 - 极大概率: O(N)
 - 只需要遍历`0~2`次
 - 理论最差: O(N^2)
 - 精心构造的数据可以让每次遍历都有剩余，直到第`N`次，检测到不会改变后退出循环

最后确定的临时宽度就是控件的最终宽度。而控件的另一维度，即高度，由其他属性控制。与主维度宽度相比就简单多了。

 - 如果可以缩放，在上下限之间匹配合适的高度
 - 否则就是`height`
 - 可以缩放的条件是`align: stretcht`
 - 合适的高度是指内容高度与**实际**最低高度的极大值
 - 之所以是实际，XUL中如果`<box>`使用滚动条(例如: `style="overflow:auto"`)后会改变(自身下限值的设置规则——因为可以滚动了，所以下限值变成0。

# 深入了解
 这个部分是通过栗子详细了解`<box>`布局，所以先给代码，再给问题，最后给解释。

## 例1

```xml
<hbox flex="1">
  <label crop="end" value="AAAAAAAAAAAAAAAAAAAAAAAABBBBBBBBBBBBBBBBBBBBBBBBBBBBB"/>
</hbox>
```
然后把 `hbox` 换成 `vbox`
```xml
<vbox flex="1">
  <label crop="end" value="AAAAAAAAAAAAAAAAAAAAAAAABBBBBBBBBBBBBBBBBBBBBBBBBBBBB"/>
</vbox>
```

这两个有什么区别，会裁剪字符串显示吗？

## 例2